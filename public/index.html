<script>
const SUPABASE_URL = "https://vmvjgwnnlpyucwsvpsso.supabase.co";
const SUPABASE_KEY = "..."; // نفس المفتاح
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

document.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('isLoggedIn') !== 'true') {
        window.location.href = 'login.html';
    }
});

async function fetchData() {
    const uniqueId = document.getElementById("uniqueId").value.trim();
    const stats = document.getElementById("stats");
    const radarSweep = document.getElementById("radarSweep");
    radarSweep.style.display = "block";

    try {
        const response = await fetch(`/api/proxy?unique=${encodeURIComponent(uniqueId)}`);
        const data = await response.json();
        const trips = data.trips || [];
        
        // عرض النتائج (With/Without Sonar)
        // ... الكود نفسه كما في النسخة السابقة

        // تسجيل البحث
        const userId = localStorage.getItem('userId') || null;
        await supabaseClient.from('api_logs').insert([{
            user_id: userId,
            query_type: 'unique',
            query_value: uniqueId,
            response: trips
        }]);
    } catch (error) { stats.textContent = "⚠️ Error: " + error.message; }
    finally { radarSweep.style.display = "none"; }
}
</script>
